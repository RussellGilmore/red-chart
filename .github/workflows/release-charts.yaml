name: Release Helm Charts

on:
  push:
    branches:
      - main
    paths:
      - 'charts/**'

jobs:
  release:
    permissions:
      contents: write
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6.0.2
        with:
          fetch-depth: 0

      - name: Configure Git
        run: |
          git config user.name "$GITHUB_ACTOR"
          git config user.email "$GITHUB_ACTOR@users.noreply.github.com"

      - name: Ensure gh-pages branch exists
        run: |
          # Fetch all branches to check if gh-pages exists
          git fetch origin

          # Check if gh-pages exists on remote
          if git ls-remote --exit-code --heads origin gh-pages > /dev/null 2>&1; then
            echo "gh-pages branch already exists"
          else
            echo "Creating gh-pages branch..."

            # Create orphan branch (no history)
            git checkout --orphan gh-pages

            # Remove all files from staging
            git rm -rf . || true

            # Create initial index.yaml for Helm repo
            cat > index.yaml <<EOF
          apiVersion: v1
          entries: {}
          generated: "$(date -u +"%Y-%m-%dT%H:%M:%SZ")"
          EOF

            # Add and commit
            git add index.yaml
            git commit -m "Initialize gh-pages branch with empty Helm repo index"

            # Push the new branch
            git push -u origin gh-pages

            echo "gh-pages branch created successfully"

            # Switch back to main
            git checkout main
          fi

          # Ensure we have the latest refs
          git fetch origin gh-pages

      - name: Install Helm
        uses: azure/setup-helm@v4.3.1

      - name: Run chart-releaser
        uses: helm/chart-releaser-action@v1.7.0
        with:
          charts_dir: charts
        env:
          CR_TOKEN: "${{ secrets.GITHUB_TOKEN }}"
